<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>25FW 원가 대시보드 (Auto Mapping v4.2 · MU 벤더뷰/테마 개선)</title>
<!-- CDN deps (Chart.js & plugins) -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>
<style>
  :root { --bg:#f7fafc; --card:#ffffff; --ink:#0b1117; --muted:#4b5563; --border:#e5e7eb; --red:#ef4444; --accent:#2563eb; }
  body{margin:0;background:var(--bg);color:var(--ink);font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Apple SD Gothic Neo','Noto Sans KR','Malgun Gothic','Helvetica Neue',Arial,sans-serif}
  header{position:sticky;top:0;z-index:10;background:rgba(255,255,255,.85);backdrop-filter:blur(6px);border-bottom:1px solid var(--border)}
  *{box-sizing:border-box}
  .container{max-width:1600px;margin:0 auto;padding:12px 20px}
  .row{display:grid;grid-template-columns:1fr;gap:16px}
  @media(min-width:1100px){.row{grid-template-columns:300px 1fr}}
  .card{background:var(--card);border:1px solid var(--border);border-radius:14px;box-shadow:0 1px 2px rgba(0,0,0,.06)}
  .p-16{padding:16px}
  .kpis{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
  @media(min-width:960px){.kpis{grid-template-columns:repeat(4,1fr)}}
  .label{font-size:13px;color:var(--muted)} .value{font-size:24px;font-weight:700;margin-top:4px}
  .badge{font-size:11px;border:1px solid var(--border);border-radius:999px;padding:2px 8px;color:var(--muted);background:#f3f4f6}
  .section-title{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
  .muted{color:var(--muted)}
  .controls{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  select,input[type=text],input[type=file]{border:1px solid var(--border);border-radius:10px;padding:6px 8px;font-size:13px;background:#fff;color:var(--ink)}
  input[type=range]{width:220px}
  .btn{background:var(--ink);color:#fff;border:0;border-radius:10px;padding:8px 12px;cursor:pointer}
  table{width:100%;border-collapse:collapse;font-size:13px}
/* thead 고정 + 스크롤 가독성 */
thead th{
  background:#f9fafb;color:#111827;font-weight:600;text-align:left;
  padding:8px;border-bottom:1px solid var(--border);
  position:sticky;top:0;z-index:1;
}
/* 줄바꿈 방지(헤더/셀 폭 안정화) */
tbody td{padding:8px;border-bottom:1px solid #eef2f7;white-space:nowrap}

/* ▼ 드롭다운 UI 신규 추가 */
.hdr{display:flex;align-items:center;gap:6px;position:relative}
.th-filter{display:inline-flex;align-items:center;gap:6px;cursor:pointer;user-select:none}
.th-filter .caret{font-size:10px;color:var(--muted)}
/* 크기 + 레이아웃 미세 조정 */
.dropdown{
  position:absolute; top:100%; left:0; background:#fff; border:1px solid var(--border);
  border-radius:12px; width:260px; box-shadow:0 12px 24px rgba(0,0,0,.08);
  z-index:20; display:none; padding:8px;
}
.dropdown.show{display:flex; flex-direction:column;}
/* 검색 인풋은 상단에, 옵션 목록만 스크롤 */
.dropdown .search{width:100%;border:1px solid var(--border);border-radius:8px;padding:6px 8px;font-size:12px;margin-bottom:6px}
.dropdown .opts{overflow:auto; max-height:min(260px, 40vh);}  /* 목록 스크롤 영역 */
.opt{display:flex;align-items:center;gap:8px;padding:4px 2px}
.opt input{width:14px;height:14px}
.opt label{font-size:12px;color:#111827;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;flex:1}
.opt.select-all{border-bottom:1px solid var(--border);padding-bottom:6px;margin-bottom:6px}
/* 풋터는 항상 보이게 고정 */
.dropdown .footer{position:sticky; bottom:0; background:#fff; padding-top:8px; display:flex; gap:8px; justify-content:flex-end}
.dropdown .btn-mini{border:1px solid var(--border);border-radius:8px;background:#fff;padding:4px 10px;font-size:12px;cursor:pointer}


  tbody tr:nth-child(even){background:#fbfdff}
  .num{text-align:right;font-variant-numeric:tabular-nums}
  .danger{color:var(--red)}
  .hint{font-size:12px;color:var(--muted)}
  .grid-2-half{display:grid;grid-template-columns:1fr;gap:16px}
  @media(min-width:960px){.grid-2-half{grid-template-columns:1fr 1fr}}
  .chip{border:1px solid var(--border);border-radius:999px;padding:2px 8px;font-size:12px;color:#111827;background:#fff;cursor:pointer}
  .chip.active{background:var(--accent);border-color:var(--accent);color:#fff}
  .hdr{display:flex;flex-direction:column;gap:6px}
  .hdr select{background:#fff;color:#111827;border:1px solid var(--border);border-radius:8px;padding:2px 6px;font-size:12px}
</style>
</head>
<body>
<header>
  <div class="container">
    <div style="display:flex;align-items:center;gap:10px">
      <div style="width:30px;height:30px;border-radius:8px;background:var(--accent)"></div>
      <h1 style="font-size:18px;margin:0">25FW 원가 대시보드 (CSV 로컬용 · v4.2)</h1>
      <span class="badge">MU 벤더뷰 / 색 테마 개선</span>
    </div>
    <div class="controls" style="margin-top:8px">
      <label class="hint">CSV:</label><input id="fileInput" type="file" accept=".csv" />
      <span class="hint">목표 M/U</span>
      <input id="muSlider" type="range" min="4.0" max="8.0" step="0.1" value="5.5" />
      <input id="muInput" type="number" step="0.1" min="4.0" max="8.0" value="5.5" style="width:72px" />
      <span class="chip" data-mu="5.5">5.5</span>
      <span class="chip" data-mu="5.7">5.7</span>
      <span class="chip" data-mu="6.0">6.0</span>
      <span class="chip" data-mu="6.5">6.5</span>
    </div>
  </div>
</header>

<div class="container">
  <div class="row">
    <aside class="card p-16">
      <div style="font-weight:600;margin-bottom:12px">필터</div>
      <div class="muted">복종 (ITEM)</div><select id="fItem" style="width:100%"></select>
      <div class="muted" style="margin-top:10px">벤더</div><select id="fVendor" style="width:100%"></select>
      <div class="muted" style="margin-top:10px">FIT</div><select id="fFit" style="width:100%"></select>
      <div class="muted" style="margin-top:10px">DOMAIN</div><select id="fDomain" style="width:100%"></select>
      <div class="muted" style="margin-top:10px">스타일 (번호/설명)</div><input id="fStyle" type="text" placeholder="STYLE_NO / DESCRIPTION" style="width:100%"/>
      <button class="btn" id="btnReset" style="width:100%;margin-top:12px">필터 초기화</button>
    </aside>

    <main>
      <div class="kpis">
        <div class="card p-16"><div class="label">평균 M/U (물량 가중)</div><div class="value" id="kpiMuAvg">-</div><div class="hint">목표 <span id="muTargetLabel">5.5</span></div></div>
        <div class="card p-16">
          <div class="section-title"><div class="label">복종별 평균 공임($)</div><span class="badge" id="cmMode">by ITEM</span></div>
          <canvas id="miniCM" height="160"></canvas>
        </div>
        <div class="card p-16"><div class="label">Red Flag 스타일</div><div class="value" id="kpiRed">-</div><div class="hint">M/U &lt; <span id="muTargetLabel2">5.5</span></div></div>
        <div class="card p-16"><div class="label">벤더 수</div><div class="value" id="kpiVendors">-</div></div>
      </div>

      <div class="grid-2-half" style="margin-top:16px">
        <div class="card p-16">
          <div class="section-title"><div style="font-weight:600">복종별 평균 원가 구조 (비가중 · COST_VAT=100%)</div><span class="badge">DJ/DV: Insulation 포함(USD→₩)</span></div>
          <canvas id="chartCost" height="160"></canvas>
        </div>
        <div class="card p-16">
          <div class="section-title"><div style="font-weight:600">M/U 트래킹 (복종별, 가중)</div><span class="badge">Target 라인 + 값</span></div>
          <canvas id="chartMU" height="160"></canvas>
        </div>
      </div>

      <div class="card p-16" style="margin-top:16px">
        <div class="section-title"><div style="font-weight:600">스타일 상세</div><span class="badge">Header dropdown filters</span></div>
        <div style="overflow:auto; max-height: 320px; border-top:1px solid #1f2937; margin-top:8px;">
<table id="tblDetail">
  <thead>
    <tr>
      <th data-col="STYLE_NO">
        <div class="hdr"><span class="th-filter">STYLE_NO <span class="caret">▼</span></span><div class="dropdown"></div></div>
      </th>
      <th data-col="ITEM">
        <div class="hdr"><span class="th-filter">ITEM <span class="caret">▼</span></span><div class="dropdown"></div></div>
      </th>
      <th data-col="VENDOR_1ST">
        <div class="hdr"><span class="th-filter">VENDOR_1ST <span class="caret">▼</span></span><div class="dropdown"></div></div>
      </th>
      <!-- 신규 열: TTL_QTY -->
      <th data-col="QTY_TTL" class="num">
        <div class="hdr"><span class="th-filter">TTL_QTY <span class="caret">▼</span></span><div class="dropdown"></div></div>
      </th>
      <th data-col="TAG" class="num">
        <div class="hdr"><span class="th-filter">TAG <span class="caret">▼</span></span><div class="dropdown"></div></div>
      </th>
      <th data-col="COST_VAT" class="num">
        <div class="hdr"><span class="th-filter">COST_VAT <span class="caret">▼</span></span><div class="dropdown"></div></div>
      </th>
      <th data-col="MU" class="num">
        <div class="hdr"><span class="th-filter">MU <span class="caret">▼</span></span><div class="dropdown"></div></div>
      </th>
      <th data-col="MU_TARGET_GAP" class="num">
        <div class="hdr"><span class="th-filter">MU_TARGET_GAP <span class="caret">▼</span></span><div class="dropdown"></div></div>
      </th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

        </div>
      </div>

      <div class="card p-16" style="margin-top:16px;">
        <div class="section-title"><div style="font-weight:600">Red Flag 스타일 (목표 M/U 미만)</div><span class="badge">납기일 제거 / 필요원가·감액표시</span></div>
        <div style="overflow:auto; max-height: 360px; border-top:1px solid #1f2937; margin-top:8px;">
<table id="tblRed">
  <thead>
    <tr>
      <th data-col="STYLE_NO">
        <div class="hdr"><span class="th-filter">STYLE_NO <span class="caret">▼</span></span><div class="dropdown"></div></div>
      </th>
      <th data-col="ITEM">
        <div class="hdr"><span class="th-filter">ITEM <span class="caret">▼</span></span><div class="dropdown"></div></div>
      </th>
      <th data-col="VENDOR_1ST">
        <div class="hdr"><span class="th-filter">VENDOR_1ST <span class="caret">▼</span></span><div class="dropdown"></div></div>
      </th>
      <th data-col="MU" class="num">
        <div class="hdr"><span class="th-filter">MU <span class="caret">▼</span></span><div class="dropdown"></div></div>
      </th>
      <th data-col="TAG" class="num">
        <div class="hdr"><span class="th-filter">TAG <span class="caret">▼</span></span><div class="dropdown"></div></div>
      </th>
      <th data-col="COST_VAT" class="num">
        <div class="hdr"><span class="th-filter">COST_VAT <span class="caret">▼</span></span><div class="dropdown"></div></div>
      </th>
      <th data-col="REDUCE_NEED" class="num">
        <div class="hdr"><span class="th-filter">감액 필요(₩) <span class="caret">▼</span></span><div class="dropdown"></div></div>
      </th>

      <th data-col="SHELL_PRICE_USD" class="num">
        <div class="hdr"><span class="th-filter">SHELL_PRICE($) <span class="caret">▼</span></span><div class="dropdown"></div></div>
      </th>
      <th data-col="CM_USD" class="num">
        <div class="hdr"><span class="th-filter">CM($) <span class="caret">▼</span></span><div class="dropdown"></div></div>
      </th>
      <th data-col="SHELL">
        <div class="hdr"><span class="th-filter">SHELL <span class="caret">▼</span></span><div class="dropdown"></div></div>
      </th>
      <th data-col="SHELL_SUPPLIER">
        <div class="hdr"><span class="th-filter">SHELL_SUPPLIER <span class="caret">▼</span></span><div class="dropdown"></div></div>
      </th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

        </div>
      </div>

    </main>
  </div>
</div>

<script>
(() => {
  let MU_TARGET = 5.5;
  const EXRATE = 1420;

  const CANON = {
    STYLE_NO:'STYLE_NO', STYLE_DESCRIPTION:'STYLE_DESCRIPTION', ITEM:'ITEM', VENDOR:'VENDOR_1ST',
    FIT:'FIT', DOMAIN:'DOMAIN', TAG:'TAG', COST:'COST_VAT', MU:'MU', MU_W:'MU_WEIGHTED',
    TTL_FABRIC:'TTL_FABRIC', TTL_SHELL:'TTL_SHELL', TTL_LINING:'TTL_LINING', POCKET:'POCKETING_ETC',
    TTL_ARTWORK:'TTL_ARTWORK', TTL_TRIM:'TTL_TRIM', CM:'CM_USD',
    SHELL:'SHELL', SHELL_SUPPLIER:'SHELL_SUPPLIER', SHELL_PRICE:'SHELL_PRICE_USD', SHELL_CONS:'SHELL_CONS',
    INS:'INSULATION', INS_PRICE:'INSULATION_PRICE_USD', INS_CONS:'INSULATION_CONS', TTL_INS:'TTL_INSULATION_USD',
    QTY:'QTY_TTL', TTL_COST:'TTL_COST', TTL_TAG:'TTL_TAG'
  };

  const el = (id)=>document.getElementById(id);
  const fileInput=el('fileInput'); const muSlider=el('muSlider'); const muInput=el('muInput');
  const muLabel1=el('muTargetLabel'), muLabel2=el('muTargetLabel2');
  const chips = Array.from(document.querySelectorAll('.chip'));
  const fItem=el('fItem'), fVendor=el('fVendor'), fFit=el('fFit'), fDomain=el('fDomain'), fStyle=el('fStyle'), btnReset=el('btnReset');
  const kpiMuAvg=el('kpiMuAvg'), kpiRed=el('kpiRed'), kpiVendors=el('kpiVendors'), cmMode=el('cmMode');
const tblDetailBody=el('tblDetail').querySelector('tbody'),tblRedBody=el('tblRed').querySelector('tbody');

  let raw=[], filtered=[], map={};
  let miniCM, chartCost, chartMU;

  const toNum = (x)=>{ if(x===null||x===undefined||x==='') return NaN; const n=Number(String(x).replace(/,/g,'')); return isNaN(n)?NaN:n; };
  const sum = (a)=>a.reduce((acc,v)=>acc+(toNum(v)||0),0);
  const avg = (a)=>{ const v=a.map(toNum).filter(x=>!isNaN(x)); return v.length? v.reduce((p,c)=>p+c,0)/v.length : NaN; };
  const fmtKRW = (v)=> isNaN(toNum(v))?'-':'₩'+Math.round(toNum(v)).toLocaleString('ko-KR');
  const fmtUSD = (v)=> isNaN(toNum(v))?'-':'$'+toNum(v).toFixed(2);
  function norm(s){ return String(s||'').trim().toLowerCase().replace(/\s+/g,' ').replace(/_/g,' ').replace(/\(.*?\)/g,'').replace(/[^a-z0-9가-힣 ]/g,''); }
  function buildMap(headers){
    const lc=headers.map(h=>norm(h)); const byLc=Object.fromEntries(lc.map((k,i)=>[k, headers[i]]));
    Object.values(CANON).forEach(cn=>{ const k=norm(cn); if(byLc[k]) map[cn]=byLc[k]; });
    headers.forEach(h=>{ const n=norm(h); if(n.includes('ttl cost')) map[CANON.TTL_COST]=h; if(n.includes('ttl tag')) map[CANON.TTL_TAG]=h; });
    headers.forEach(h=>{ const n=norm(h); if(n.includes('insulation price usd')) map[CANON.INS_PRICE]=h; if(n.includes('insulation cons')) map[CANON.INS_CONS]=h; if(n.includes('ttl insulation usd')) map[CANON.TTL_INS]=h; });
  }
  const get=(r,canon)=> r[ map[canon] || canon ];
  const ttlCost=r=>{ const hdr=(map[CANON.TTL_COST]||CANON.TTL_COST).toLowerCase(); const n=toNum(get(r,CANON.TTL_COST)); if(isNaN(n))return NaN; return hdr.includes('억')? n*1e8 : n; };
  const ttlTag=r=>{ const hdr=(map[CANON.TTL_TAG]||CANON.TTL_TAG).toLowerCase(); const n=toNum(get(r,CANON.TTL_TAG)); if(isNaN(n))return NaN; return hdr.includes('억')? n*1e8 : n; };
  const insUSD=r=>{ const t=toNum(get(r,CANON.TTL_INS)); if(!isNaN(t)) return t; const p=toNum(get(r,CANON.INS_PRICE)), c=toNum(get(r,CANON.INS_CONS)); const v=p*c; return isNaN(v)?NaN:v; };
  const groupBy=(rows,key)=>rows.reduce((acc,r)=>{ const k=key(r)??'-'; (acc[k] ||= []).push(r); return acc; },{});

  /* 축약 벤더명 유틸 */
  function shortVendor(name){
    const m = {
      'ITOCHU TEXTILE(CHINA)CO.,LTD.': 'ITOCHU',
      '(주)포마트코퍼레이션': '포마트',
      '(주)기도산업': '기도',
      '티피나디아㈜': '나디아',
      '원전교역': '원전',
      '주)무브 플러스': '무브',
      '㈜노브랜드(우븐)': '노브랜드',
      '주식회사 거림씨앤에프': '거림',
      '(주)신한어패럴': '신한'
    };
    if (!name) return '-';
    if (m[name]) return m[name];
    return String(name).replace(/\(.*?\)/g,'').replace(/\s+/g,' ').trim().slice(0,10);
  }

  function populateFilters(rows){
    const uniq = (arr)=>['All', ...Array.from(new Set(arr.filter(Boolean)))];
    fItem.innerHTML=uniq(rows.map(r=>get(r,CANON.ITEM))).map(v=>`<option>${v}</option>`).join('');
    fVendor.innerHTML=uniq(rows.map(r=>get(r,CANON.VENDOR))).map(v=>`<option>${v}</option>`).join('');
    fFit.innerHTML=uniq(rows.map(r=>get(r,CANON.FIT))).map(v=>`<option>${v}</option>`).join('');
    fDomain.innerHTML=uniq(rows.map(r=>get(r,CANON.DOMAIN))).map(v=>`<option>${v}</option>`).join('');
    fItem.value='All'; fVendor.value='All'; fFit.value='All'; fDomain.value='All'; fStyle.value='';
  }
  function applyFilters(){
    filtered = raw.filter(r=>{
      if (fItem.value!=='All' && get(r,CANON.ITEM)!==fItem.value) return false;
      if (fVendor.value!=='All' && get(r,CANON.VENDOR)!==fVendor.value) return false;
      if (fFit.value!=='All' && get(r,CANON.FIT)!==fFit.value) return false;
      if (fDomain.value!=='All' && get(r,CANON.DOMAIN)!==fDomain.value) return false;
      if (fStyle.value){ const q=fStyle.value.toLowerCase(); const a=String(get(r,CANON.STYLE_NO)||'').toLowerCase(); const b=String(get(r,CANON.STYLE_DESCRIPTION)||'').toLowerCase(); if(!a.includes(q)&&!b.includes(q)) return false; }
      return true;
    });
  }

  /* -------- 복종별 평균 공임($) -------- */
  function renderMiniCM(){
    if (miniCM) miniCM.destroy();
    const itemSel=fItem.value!=='All', vendorSel=fVendor.value!=='All', fitSel=fFit.value!=='All';
    let labels=[], data1=[], data2=null, mode='by ITEM';

    if(itemSel && !vendorSel && !fitSel){
      mode = `Vendors in ${fItem.value}`;
      const rows=filtered.filter(r=>get(r,CANON.ITEM)===fItem.value);
      const g=groupBy(rows, r=>get(r,CANON.VENDOR)||'-');
      const keys=Object.keys(g);
      labels = keys.map(shortVendor);                /* ← 축약 라벨 */
      data1  = keys.map(k=>avg(g[k].map(r=>toNum(get(r,CANON.CM)))));
    } else if (vendorSel && !itemSel){
      mode = `Vendor vs All (${fVendor.value})`;
      const gAll=groupBy(filtered, r=>get(r,CANON.ITEM)); labels=Object.keys(gAll);
      const vendorRows=raw.filter(r=>get(r,CANON.VENDOR)===fVendor.value); const gVendor=groupBy(vendorRows, r=>get(r,CANON.ITEM));
      const all=labels.map(k=>avg((gAll[k]||[]).map(r=>toNum(get(r,CANON.CM)))));
      const sel=labels.map(k=>avg((gVendor[k]||[]).map(r=>toNum(get(r,CANON.CM)))));
      data1=all; data2=sel;
    } else if (fitSel && !itemSel){
      mode = `FIT vs All (${fFit.value})`;
      const gAll=groupBy(filtered, r=>get(r,CANON.ITEM)); labels=Object.keys(gAll);
      const fitRows=raw.filter(r=>get(r,CANON.FIT)===fFit.value); const gFit=groupBy(fitRows, r=>get(r,CANON.ITEM));
      const all=labels.map(k=>avg((gAll[k]||[]).map(r=>toNum(get(r,CANON.CM)))));
      const sel=labels.map(k=>avg((gFit[k]||[]).map(r=>toNum(get(r,CANON.CM)))));
      data1=all; data2=sel;
    } else {
      const g=groupBy(filtered, r=>get(r,CANON.ITEM)||'-'); labels=Object.keys(g);
      data1=labels.map(k=>avg(g[k].map(r=>toNum(get(r,CANON.CM)))));
    }
    cmMode.textContent=mode;

    const ctx=document.getElementById('miniCM').getContext('2d');
    miniCM=new Chart(ctx,{
      type:'bar',
      data:{
        labels,
        datasets:[
          {label: data2? 'All' : 'Avg CM($)', data:data1, backgroundColor:'#e5e7eb'}
        ].concat(data2?[{label:'Selected',data:data2,backgroundColor:'#10b98122',borderColor:'#10b981',borderWidth:1.5}]:[])
      },
      options:{
        plugins:{
          legend:{ position: data2? 'bottom':'false' },
          tooltip:{ callbacks:{ label: c=>` ${c.dataset.label}: ${ (c.parsed.y??0).toFixed(1) }` } },
        },
        scales:{ x:{ ticks:{ color:'#64748b' } }, y:{ ticks:{ color:'#64748b' } } }
      },
      plugins:[{
        id:'labels',
        afterDatasetsDraw(chart){ const {ctx}=chart; ctx.save(); ctx.font='9.5px sans-serif'; ctx.fillStyle='#111827';
          chart.data.datasets.forEach((ds,di)=>{
            chart.getDatasetMeta(di).data.forEach((bar,bi)=>{ const v=ds.data[bi]; if(!isNaN(v)) ctx.fillText(Number(v).toFixed(1), bar.x-10, bar.y-6); });
          });
        }
      }]
    });
  }

  /* -------- 원가 구조: 부드러운 파스텔 테마 + 라벨 가독성 -------- */
  function renderCostStructure(){
    if (chartCost) chartCost.destroy();
    const g = groupBy(filtered, r=>get(r,CANON.ITEM));
    const labels = Object.keys(g);
    const stacks = labels.map(item => {
      const rows = g[item];
      const cost = avg(rows.map(r=>toNum(get(r,CANON.COST))));
      const shell = avg(rows.map(r=>toNum(get(r,CANON.TTL_SHELL))));
      const lining = avg(rows.map(r=>toNum(get(r,CANON.TTL_LINING))));
      const pocket = avg(rows.map(r=>toNum(get(r,CANON.POCKET))));
      const artwork = avg(rows.map(r=>toNum(get(r,CANON.TTL_ARTWORK))));
      const trim = avg(rows.map(r=>toNum(get(r,CANON.TTL_TRIM))));
      const cm = avg(rows.map(r=>toNum(get(r,CANON.CM)) * EXRATE));
      const ins = (item==='DJ'||item==='DV') ? avg(rows.map(r=> ( (toNum(get(r,CANON.TTL_INS))) || (toNum(get(r,CANON.INS_PRICE))*toNum(get(r,CANON.INS_CONS))) ) * EXRATE )) : 0;
      const known = [shell,lining,pocket,artwork,trim,cm,ins].map(v=>isNaN(v)?0:v).reduce((a,b)=>a+b,0);
      const etc = Math.max(0, cost - known);
      const denom = cost>0 ? cost : 1;
      const pct = (x)=> (x/denom*100);
      return [ pct(shell||0), pct(lining||0), pct(pocket||0), pct(artwork||0), pct(trim||0), pct(cm||0), pct(ins||0), pct(etc||0) ];
    });

    /* 은은한 파스텔 팔레트 (라벨 가독성 위해 약간 명도 차등) */
    const colors=[
  '#f8d7da', // Shell - pastel pink
  '#fde2b3', // Lining - pastel orange
  '#fff3b0', // Pocket/Etc - pastel yellow
  '#d4f4dd', // Artwork - pastel mint
  '#bae6fd', // Trim - pastel blue
  '#d1c4e9', // CM - pastel purple
  '#c8e6c9', // Insulation - pastel green
  '#eceff1'  // ETC - light grey
];
    const labelsSeg=['Shell','Lining','Pocket/Etc','Artwork','Trim','CM','Insulation','ETC'];
    const datasets = colors.map((c,i)=>({
      label:labelsSeg[i],
      data: stacks.map(s=>s[i]),
      backgroundColor:c,
      borderColor:'#ffffff',
      borderWidth:1,
      stack:'s'
    }));
    const ctx=document.getElementById('chartCost').getContext('2d');
    chartCost=new Chart(ctx,{ type:'bar', data:{ labels, datasets },
      options:{responsive:true, scales:{ x:{stacked:true}, y:{stacked:true, suggestedMax:100, ticks:{callback:v=>v+'%'}}}, plugins:{legend:{position:'bottom'}}},
      plugins:[{
        id:'segPct',
        afterDatasetsDraw(chart){ const {ctx}=chart; ctx.save(); ctx.font='11px sans-serif'; ctx.fillStyle='#1f2937';
          for(let di=0; di<chart.data.datasets.length; di++){
            const meta=chart.getDatasetMeta(di);
            meta.data.forEach((bar,bi)=>{ const val=chart.data.datasets[di].data[bi]; if(isNaN(val)||val<7) return; ctx.fillText(Math.round(val)+'%', bar.x-12, bar.y+12); });
          }
        }
      }]
    });
  }

  /* -------- M/U 트래킹: 복종 선택 시 벤더별 + 은은한 색 -------- */
  function renderMU(){
    if (chartMU) chartMU.destroy();

    const itemSel   = fItem.value !== 'All';
    const vendorSel = fVendor.value !== 'All';
    const fitSel    = fFit.value    !== 'All';
    const domainSel = fDomain.value !== 'All';

    const muWeighted = (rows) => { const C=sum(rows.map(ttlCost)); const T=sum(rows.map(ttlTag)); return C>0? (T/C):NaN; };

    let labels=[], datasets=[];

    if (itemSel) {
      const item = fItem.value;
      const vendorRows = filtered.filter(r => get(r, CANON.ITEM) === item);
      const vendors = Array.from(new Set(vendorRows.map(r => get(r, CANON.VENDOR) || '-')));
      labels = vendors.map(shortVendor);
      const dataVendor = vendors.map(v => muWeighted(vendorRows.filter(r => (get(r, CANON.VENDOR) || '-') === v)));

      datasets = [
        { label: `${item} · Vendors (Filtered)`, data: dataVendor, backgroundColor:'#a7f3d0', borderColor:'#10b981', borderWidth:1 } /* ← 부드러운 민트 */
      ];
    } else {
      const items = Object.keys(groupBy(raw, r => get(r, CANON.ITEM)));
      labels = items;

      if (vendorSel || fitSel || domainSel) {
        const dataAll = items.map(item => muWeighted(raw.filter(r => get(r, CANON.ITEM) === item)));
        const dataSel = items.map(item => muWeighted(filtered.filter(r => get(r, CANON.ITEM) === item)));
        datasets = [
          { label:'All',      data:dataAll, backgroundColor:'#cbd5e1' },
          { label:'Filtered', data:dataSel, backgroundColor:'#10b98122', borderColor:'#10b981', borderWidth:1.5 }
        ];
      } else {
        const data = items.map(item => muWeighted(filtered.filter(r => get(r, CANON.ITEM) === item)));
        datasets = [{ label:'평균 M/U (가중)', data, backgroundColor:'#e5e7eb' }];
      }
    }

    const ctx = document.getElementById('chartMU').getContext('2d');
    chartMU = new Chart(ctx, {
      type: 'bar',
      data: { labels, datasets },
      options: {
        scales: { y:{ beginAtZero:true, ticks:{ color:'#64748b' } }, x:{ ticks:{ color:'#64748b' } } },
        plugins: {
          legend: { display: true, position: 'bottom' },
          annotation: {
            annotations: {
              line: { type:'line', yMin:MU_TARGET, yMax:MU_TARGET, borderColor:'#ef4444', borderDash:[6,4], borderWidth:2,
                      label:{display:true, content:'Target '+MU_TARGET.toFixed(1)} }
            }
          },
          tooltip: { callbacks:{ label: c=>` ${c.dataset.label}: ${(c.parsed.y ?? 0).toFixed(2)}` } }
        }
      },
      plugins:[{
        id:'valueOnTop',
        afterDatasetsDraw(chart){ const {ctx}=chart; ctx.save(); ctx.font='10px sans-serif'; ctx.fillStyle='#111827';
          chart.data.datasets.forEach((ds,di)=>{ chart.getDatasetMeta(di).data.forEach((bar,bi)=>{ const v=ds.data[bi]; if(!isNaN(v)) ctx.fillText(Number(v).toFixed(2), bar.x-10, bar.y-6); }); });
        }
      }]
    });
  }

  /* -------- 테이블 헤더 드롭다운 필터 -------- */
function buildTableDropdowns(tableId, rows, renderFn){
  const table = document.getElementById(tableId);
  const ths = Array.from(table.querySelectorAll('thead th'));
  const state = {};       // 확정 상태: null = 전체, Set = 부분 선택
  const valuesByCol = {}; // 각 컬럼별 유니크 값

  const getVal = (r, col)=>{
    if(col==='REDUCE_NEED'){
      const tag = toNum(r[map[CANON.TAG]||CANON.TAG]);
      const need = tag / MU_TARGET;
      const cur  = toNum(r[map[CANON.COST]||CANON.COST]);
      const reduce = cur - need;
      return isNaN(reduce)?'':fmtKRW(reduce);
    }
    return (r[col] ?? r[map[col]] ?? r[col]) ?? '';
  };
  ths.forEach(th=>{
    const col = th.getAttribute('data-col'); if(!col) return;
    const vals = Array.from(new Set(rows.map(r=>getVal(r,col)).filter(v=>v!=='')));
    valuesByCol[col] = vals;
    state[col] = null; // 기본: 전체 선택
  });

  // 드롭다운 DOM 구성 + 이벤트
  ths.forEach(th=>{
    const col = th.getAttribute('data-col'); if(!col) return;
    const hdr = th.querySelector('.hdr');
    const dd  = hdr.querySelector('.dropdown');
    const trigger = hdr.querySelector('.th-filter');

trigger.addEventListener('click', (e)=>{
  e.stopPropagation();
  closeAllDropdowns();
  dd.classList.toggle('show');

  // 내부 DOM
  dd.innerHTML = `
    <input class="search" type="text" placeholder="검색..." />
    <div class="opt select-all">
      <input type="checkbox" class="check-all"/><label>(모두 선택)</label>
    </div>
    <div class="opts"></div>
    <div class="footer">
      <button class="btn-mini ok">확인</button>
      <button class="btn-mini cancel">취소</button>
    </div>
  `;

  /* 드롭다운 높이를 카드/화면에 맞춰 동적 제한 */
  const optsEl = dd.querySelector('.opts');
  const MARGIN = 24;           // 아래 여백
  const HEAD_FOOT = 96;        // 검색 + (모두선택) + 풋터 대략치
  // 화면 하단까지 남은 여유(픽셀)
  const rect = dd.getBoundingClientRect();
  const spaceBelow = window.innerHeight - rect.top - MARGIN;
  // 최종 허용 높이(180~360 범위 내)
  const avail = Math.max(180, Math.min(360, spaceBelow));
  dd.style.maxHeight = avail + 'px';
  optsEl.style.maxHeight = Math.max(120, avail - HEAD_FOOT) + 'px';

  // 나머지 기존 코드 (검색/체크/확인/취소 바인딩…) 그대로 유지
  const searchEl = dd.querySelector('.search');
  const okBtn    = dd.querySelector('.ok');
  const cancelBtn= dd.querySelector('.cancel');
  const checkAll = dd.querySelector('.check-all');

      // 열린 동안만 사용하는 임시 선택 상태
      let tempSel = state[col] ? new Set(state[col]) : null;
      let shown = [];

      function renderOpts(){
        const ft = (searchEl.value||'').trim().toLowerCase();
        shown = valuesByCol[col].filter(v => !ft || String(v).toLowerCase().includes(ft));
        optsEl.innerHTML = shown.map(v=>{
          const checked = !tempSel || tempSel.has(String(v));
          return `<div class="opt"><input type="checkbox" value="${String(v).replace(/"/g,'&quot;')}" ${checked?'checked':''}/><label title="${v}">${v}</label></div>`;
        }).join('') || `<div class="muted" style="padding:6px 2px;">옵션 없음</div>`;
        updateSelectAllState();
      }

      function updateSelectAllState(){
        if(shown.length===0){ checkAll.indeterminate=false; checkAll.checked=false; return; }
        const checkedCnt = shown.reduce((acc,v)=>acc + ((!tempSel || tempSel.has(String(v)))?1:0), 0);
        checkAll.indeterminate = checkedCnt>0 && checkedCnt<shown.length;
        checkAll.checked = checkedCnt===shown.length;
      }

      // (모두 선택): 현재 보이는 항목 기준
      checkAll.addEventListener('change', ()=>{
        if(checkAll.checked){
          if(tempSel){ shown.forEach(v=>tempSel.add(String(v))); }
          if(tempSel && tempSel.size===valuesByCol[col].length) tempSel=null; // 모두 선택 → 전체(null)
        }else{
          if(!tempSel) tempSel = new Set(valuesByCol[col]); // 전체에서 부분으로 전환
          shown.forEach(v=>tempSel.delete(String(v)));
        }
        renderOpts();
      });

      // 개별 체크(이 핸들러는 열 때마다 교체해서 중복 방지)
      dd.onchange = (ev)=>{
        if(ev.target && ev.target.matches('.opts input[type=checkbox]')){
          const v = ev.target.value;
          if(!tempSel) tempSel = new Set(valuesByCol[col]);
          if(ev.target.checked) tempSel.add(v); else tempSel.delete(v);
          if(tempSel.size===valuesByCol[col].length) tempSel=null; // 전체로 축약
          updateSelectAllState();
        }
      };

      // 검색
      searchEl.addEventListener('input', renderOpts);

      // 확인/취소
      okBtn.addEventListener('click', ()=>{
        state[col] = tempSel;      // 확정 반영
        applyAndRender();
        dd.classList.remove('show');
      });
      cancelBtn.addEventListener('click', ()=>{
        dd.classList.remove('show'); // 반영 안 함
      });

      renderOpts(); // 초기 렌더
    });
  });

  // 필터 통과 여부
  function passRow(r){
    for(const [col, sel] of Object.entries(state)){
      if(!sel) continue; // 전체
      const cellVal = getVal(r, col);
      if(!sel.has(String(cellVal))) return false;
    }
    return true;
  }
  function applyAndRender(){ renderFn(rows.filter(passRow)); }

  // 초기 렌더
  applyAndRender();
}

/* 전역: 바깥 클릭 시 모든 드롭다운 닫기(중복 등록 없이 1회) */
function closeAllDropdowns(){
  document.querySelectorAll('.dropdown.show').forEach(x=>x.classList.remove('show'));
}
document.addEventListener('click', (ev)=>{
  if(ev.target.closest('.dropdown') || ev.target.closest('.th-filter')) return;
  closeAllDropdowns();
});

function renderDetailRows(rows){
  const html=rows.map(r=>{
    const mu=toNum(get(r,CANON.MU)); const gap=isNaN(mu)?NaN: (mu - MU_TARGET);
    const qty=toNum(get(r,CANON.QTY));
    return `<tr class="${mu<MU_TARGET?'danger':''}">
      <td>${get(r,CANON.STYLE_NO)||'-'}</td>
      <td>${get(r,CANON.ITEM)||'-'}</td>
      <td>${get(r,CANON.VENDOR)||'-'}</td>
      <td class="num">${isNaN(qty)?'-':qty.toLocaleString('ko-KR')}</td>
      <td class="num">${fmtKRW(get(r,CANON.TAG))}</td>
      <td class="num">${fmtKRW(get(r,CANON.COST))}</td>
      <td class="num">${isNaN(mu)?'-':mu.toFixed(2)}</td>
      <td class="num">${isNaN(gap)?'-':gap.toFixed(2)}</td>
    </tr>`;
  }).join('');
  tblDetailBody.innerHTML=html||'<tr><td colspan="8" class="muted">No rows</td></tr>';
}

function renderRedRows(rows){
  const reds=rows.filter(r=>toNum(get(r,CANON.MU))<MU_TARGET);
  const html=reds.map(r=>{
    const tag=toNum(get(r,CANON.TAG));
    const need=tag/MU_TARGET; // 내부 계산만 사용
    const cur=toNum(get(r,CANON.COST));
    const reduce=cur-need;
    return `<tr>
      <td>${get(r,CANON.STYLE_NO)||'-'}</td>
      <td>${get(r,CANON.ITEM)||'-'}</td>
      <td>${get(r,CANON.VENDOR)||'-'}</td>
      <td class="num danger">${toNum(get(r,CANON.MU)).toFixed(2)}</td>
      <td class="num">${fmtKRW(tag)}</td>
      <td class="num">${fmtKRW(cur)}</td>
      <td class="num">${fmtKRW(reduce)}</td>
      <td class="num">${fmtUSD(get(r,CANON.SHELL_PRICE))}</td>
      <td class="num">${fmtUSD(get(r,CANON.CM))}</td>
      <td>${get(r,CANON.SHELL)||'-'}</td>
      <td>${get(r,CANON.SHELL_SUPPLIER)||'-'}</td>
    </tr>`;
  }).join('');
  tblRedBody.innerHTML=html||'<tr><td colspan="11" class="muted">No red flags</td></tr>';
}


  function updateKPIs(){
    const ttlC=sum(filtered.map(r=>ttlCost(r))); const ttlT=sum(filtered.map(r=>ttlTag(r))); const muW=ttlC>0? ttlT/ttlC : NaN;
    kpiMuAvg.textContent=isNaN(muW)?'-':muW.toFixed(2);
    const red=filtered.filter(r=>toNum(get(r,CANON.MU))<MU_TARGET).length; kpiRed.textContent=red;
    const vendors=new Set(filtered.map(r=>get(r,CANON.VENDOR)).filter(Boolean)); kpiVendors.textContent=vendors.size;
  }

  function recomputeAll(){
    applyFilters();
    updateKPIs();
    renderMiniCM();
    renderCostStructure();
    renderMU();
    buildTableDropdowns('tblDetail', filtered, renderDetailRows);
    buildTableDropdowns('tblRed', filtered, renderRedRows);
  }

  function setMU(target){
    MU_TARGET = Math.max(4.0, Math.min(8.0, Number(target)||5.5));
    muSlider.value = MU_TARGET.toFixed(1);
    muInput.value = MU_TARGET.toFixed(1);
    [muLabel1, muLabel2].forEach(el=> el.textContent = MU_TARGET.toFixed(1));
    chips.forEach(c=> c.classList.toggle('active', Number(c.dataset.mu)===Number(MU_TARGET.toFixed(1)) ));
    recomputeAll();
  }

  function loadCSV(file){
    const fr=new FileReader();
    fr.onload=()=>{
      const text = fr.result.replace(/\r\n/g,'\n').replace(/\r/g,'\n');
      const rows = text.split('\n').filter(Boolean);
      const headers = rows[0].split(',').map(h=>h.trim());
      buildMap(headers);
      raw = rows.slice(1).map(line=>{
        const cells=[]; let cur='', q=false;
        for(let i=0;i<line.length;i++){
          const c=line[i];
          if(c==='\"'){ if(q && line[i+1]==='\"'){ cur+='\"'; i++; } else { q=!q; } }
          else if(c===',' && !q){ cells.push(cur); cur=''; }
          else { cur+=c; }
        }
        cells.push(cur);
        const obj={}; headers.forEach((h,idx)=> obj[h]=cells[idx]??'' ); return obj;
      });
      populateFilters(raw);
      recomputeAll();
    };
    fr.readAsText(file,'utf-8');
  }

  // Events
  fileInput.addEventListener('change', (e)=>{ const f=e.target.files[0]; if(f) loadCSV(f); });
  [fItem,fVendor,fFit,fDomain].forEach(el=>el.addEventListener('change', recomputeAll));
  document.getElementById('fStyle').addEventListener('input', recomputeAll);
  document.getElementById('btnReset').addEventListener('click', ()=>{ fItem.value='All'; fVendor.value='All'; fFit.value='All'; fDomain.value='All'; document.getElementById('fStyle').value=''; recomputeAll(); });
  muSlider.addEventListener('input', ()=> setMU(muSlider.value));
  muInput.addEventListener('change', ()=> setMU(muInput.value));
  chips.forEach(c=> c.addEventListener('click', ()=> setMU(c.dataset.mu)));

  // init
  setMU(5.5);
})();
</script>
</body>
</html>
